<head>
	<link rel="stylesheet" type="text/css" href="assets/main.css">
	<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/angular_material/0.9.4/angular-material.min.css">

	<!-- Angular Material Dependencies -->
	<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.6/angular.min.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.6/angular-animate.min.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.6/angular-aria.min.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/angular_material/0.9.4/angular-material.min.js"></script>

	<!-- External libs -->
	<!-- future remove -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="https://www.google.com/jsapi"></script>
</head>
<body  ng-app="PluviamApp"  ng-cloak>
<div ng-controller="PluviamContr">
	<div layout="column" layout-fill>
		<md-toolbar>
			<div class="md-toolbar-tools">
				<a href="http://pluvi.am" >
					<img src="/images/pluviam_menu_logo.png"/>
				</a>

				<h1 class="md-title">
					pluviam
				</h1>

				<!-- fill up the space between left and right area -->
				<span flex></span>

				<div class="md-subhead">
					<p>
						<a href="http://goo.gl/forms/y4KIgseSPn">
							Contato
						</a>
						<a href="http://pluvi.am/about">
							Sobre
						</a>
					</p>
				</div>

			</div>
		</md-toolbar>
		<md-content layout-padding>
			<div layout="row" layout-align="space-around center">
				<div class="align-center">
					<p class="md-caption">Estação Meteorológica Automática</p>
					<p class="md-body-2">{{station}}</p>
					<p class="md-caption">Lat, Long, Altitude {{weather}}</p>
				</div>
			</div>

			<div layout="row" layout-align="space-around center">
				<div class="align-center" ng-repeat="dimension in station.inputs" ng-if="dimension.chartType != 'none'">
					<div class="individual-units {{dimension.name}}"></div>
					<p class="md-caption">{{dimension.shortName}}</p>
					<span class="header-now-value">{{weather[dimension.name]}}</span>
					<span class="header-now-unit">{{dimension.unit}}</span>
				</div>
			</div>

			<div layout="row" id="indeterminateLoader" layout-sm="column" layout-align="space-around">
			<md-progress-circular md-mode="indeterminate"></md-progress-circular>
			</div>

		</md-content>
		<md-toolbar>
			<div layout="row">
				<div flex layout-margin></div>
				<div flex layout-margin><p class="md-caption">Pluviam | Saulo Matte Madalozzo ME | hello@pluvi.am</p></div>
			</div>
      	</md-toolbar>
	</div>
</div>
	<script>
	//angular


	'use strict';
var isGoogleChartReady = false;
/* Controllers */
google.load('visualization', '1', {
  packages: ['corechart']
});

google.setOnLoadCallback(function() {
	isGoogleChartReady =  true;
});


angular.module('PluviamApp', ['ngMaterial'])
.config(function($mdThemingProvider) {
  $mdThemingProvider.theme('default')
    .primaryPalette('blue')
    .accentPalette('indigo');
}).

controller('PluviamContr', ['$scope','$http',
function($scope, $http) {
	  $http.get('/r/stations/5733d44918fd93b0d0d999af').
	    success(function(results, status, headers, config) {
	    	//console.log("its ready?");
	    	/*while (!isGoogleChartReady){
	    		console.log("notready");
	    	}*/
	    	if (isGoogleChartReady){
	    	console.log("ready");

			var loader = document.getElementById('indeterminateLoader');
			//invert for each
			$.each(results.station.inputs.reverse(), function (i, row) {
				if (row.chartType !== 'none'){
					var dimension = row.name;
					console.log(dimension);
					var plotTogether = false;
					var rowPlotTogether = '';
					if(row.plotTogether !== ''){
						plotTogether = row.plotTogether;
						$.each(results.station.inputs, function (j, row2) {
							if (row2.name === plotTogether){
								rowPlotTogether = row2;
								console.log(rowPlotTogether);
							}
						});
					}
					loader.insertAdjacentHTML('afterend', '<div flex id="' + dimension + '" style="width: 100%;"></div>');
					var dimensionData = new google.visualization.DataTable();
					dimensionData.addColumn('datetime', 'Data/Hora');
					dimensionData.addColumn('number', row.shortName);
					if (plotTogether){
						console.log('added dimension data layer');
						dimensionData.addColumn('number', rowPlotTogether.shortName);
					}

					$.each(results.weather, function (i, row) {
						if (plotTogether){
  							dimensionData.addRow([(new Date(row.date)),parseFloat(row[dimension]),parseFloat(row[rowPlotTogether.name])]);
  						}else{
							dimensionData.addRow([(new Date(row.date)),parseFloat(row[dimension])]);
						}
			        });
					if (row.chartType === 'LineChart'){
						drawChart(new google.visualization.LineChart(document.getElementById(dimension)),  row.chartColors, row.shortName + ' - ' + row.unit, dimensionData);
					}else if (row.chartType === 'ColumnChart'){
						drawChart(new google.visualization.ColumnChart(document.getElementById(dimension)), row.chartColors, row.shortName + ' - ' + row.unit, dimensionData);
					}else if (row.chartType === 'AreaChart'){
						drawChart(new google.visualization.AreaChart(document.getElementById(dimension)), row.chartColors, row.shortName + ' - ' + row.unit, dimensionData);
					}

				}
			});
			loader.style.display = 'none';


			$scope.weather = results.weather[results.weather.length-1];
			$scope.station = results.station;

	    	}
	    }).
	    error(function(data, status, headers, config) {
	      // log error
	      console.log("fail");
	    });

     }

]);

    function drawChart(chart, color, title, data){
        var options = {
    		    hAxis: {
    		        format: 'HH:mm'
    		    },
			colors:color,
			legend: {position: 'none'},
			height: 300,
			title: title,
			vAxis: {minValue: 0},
			isStacked: false
    		};
        chart.draw(data, options);
    }

  </script>

</body>
